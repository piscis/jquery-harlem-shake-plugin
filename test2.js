var ready = (function(){

  var readyList,
      DOMContentLoaded,
      class2type = {};
  class2type["[object Boolean]"] = "boolean";
  class2type["[object Number]"] = "number";
  class2type["[object String]"] = "string";
  class2type["[object Function]"] = "function";
  class2type["[object Array]"] = "array";
  class2type["[object Date]"] = "date";
  class2type["[object RegExp]"] = "regexp";
  class2type["[object Object]"] = "object";

  var ReadyObj = {
    // Is the DOM ready to be used? Set to true once it occurs.
    isReady: false,
    // A counter to track how many items to wait for before
    // the ready event fires. See #6781
    readyWait: 1,
    // Hold (or release) the ready event
    holdReady: function( hold ) {
      if ( hold ) {
        ReadyObj.readyWait++;
      } else {
        ReadyObj.ready( true );
      }
    },
    // Handle when the DOM is ready
    ready: function( wait ) {
      // Either a released hold or an DOMready/load event and not yet ready
      if ( (wait === true && !--ReadyObj.readyWait) || (wait !== true && !ReadyObj.isReady) ) {
        // Make sure body exists, at least, in case IE gets a little overzealous (ticket #5443).
        if ( !document.body ) {
          return setTimeout( ReadyObj.ready, 1 );
        }

        // Remember that the DOM is ready
        ReadyObj.isReady = true;
        // If a normal DOM Ready event fired, decrement, and wait if need be
        if ( wait !== true && --ReadyObj.readyWait > 0 ) {
          return;
        }
        // If there are functions bound, to execute
        readyList.resolveWith( document, [ ReadyObj ] );

        // Trigger any bound ready events
        //if ( ReadyObj.fn.trigger ) {
        //  ReadyObj( document ).trigger( "ready" ).unbind( "ready" );
        //}
      }
    },
    bindReady: function() {
      if ( readyList ) {
        return;
      }
      readyList = ReadyObj._Deferred();

      // Catch cases where $(document).ready() is called after the
      // browser event has already occurred.
      if ( document.readyState === "complete" ) {
        // Handle it asynchronously to allow scripts the opportunity to delay ready
        return setTimeout( ReadyObj.ready, 1 );
      }

      // Mozilla, Opera and webkit nightlies currently support this event
      if ( document.addEventListener ) {
        // Use the handy event callback
        document.addEventListener( "DOMContentLoaded", DOMContentLoaded, false );
        // A fallback to window.onload, that will always work
        window.addEventListener( "load", ReadyObj.ready, false );

        // If IE event model is used
      } else if ( document.attachEvent ) {
        // ensure firing before onload,
        // maybe late but safe also for iframes
        document.attachEvent( "onreadystatechange", DOMContentLoaded );

        // A fallback to window.onload, that will always work
        window.attachEvent( "onload", ReadyObj.ready );

        // If IE and not a frame
        // continually check to see if the document is ready
        var toplevel = false;

        try {
          toplevel = window.frameElement == null;
        } catch(e) {}

        if ( document.documentElement.doScroll && toplevel ) {
          doScrollCheck();
        }
      }
    },
    _Deferred: function() {
      var // callbacks list
          callbacks = [],
      // stored [ context , args ]
          fired,
      // to avoid firing when already doing so
          firing,
      // flag to know if the deferred has been cancelled
          cancelled,
      // the deferred itself
          deferred  = {

            // done( f1, f2, ...)
            done: function() {
              if ( !cancelled ) {
                var args = arguments,
                    i,
                    length,
                    elem,
                    type,
                    _fired;
                if ( fired ) {
                  _fired = fired;
                  fired = 0;
                }
                for ( i = 0, length = args.length; i < length; i++ ) {
                  elem = args[ i ];
                  type = ReadyObj.type( elem );
                  if ( type === "array" ) {
                    deferred.done.apply( deferred, elem );
                  } else if ( type === "function" ) {
                    callbacks.push( elem );
                  }
                }
                if ( _fired ) {
                  deferred.resolveWith( _fired[ 0 ], _fired[ 1 ] );
                }
              }
              return this;
            },

            // resolve with given context and args
            resolveWith: function( context, args ) {
              if ( !cancelled && !fired && !firing ) {
                // make sure args are available (#8421)
                args = args || [];
                firing = 1;
                try {
                  while( callbacks[ 0 ] ) {
                    callbacks.shift().apply( context, args );//shifts a callback, and applies it to document
                  }
                }
                finally {
                  fired = [ context, args ];
                  firing = 0;
                }
              }
              return this;
            },

            // resolve with this as context and given arguments
            resolve: function() {
              deferred.resolveWith( this, arguments );
              return this;
            },

            // Has this deferred been resolved?
            isResolved: function() {
              return !!( firing || fired );
            },

            // Cancel
            cancel: function() {
              cancelled = 1;
              callbacks = [];
              return this;
            }
          };

      return deferred;
    },
    type: function( obj ) {
      return obj == null ?
          String( obj ) :
          class2type[ Object.prototype.toString.call(obj) ] || "object";
    }
  }
  // The DOM ready check for Internet Explorer
  function doScrollCheck() {
    if ( ReadyObj.isReady ) {
      return;
    }

    try {
      // If IE is used, use the trick by Diego Perini
      // http://javascript.nwbox.com/IEContentLoaded/
      document.documentElement.doScroll("left");
    } catch(e) {
      setTimeout( doScrollCheck, 1 );
      return;
    }

    // and execute any waiting functions
    ReadyObj.ready();
  }
  // Cleanup functions for the document ready method
  if ( document.addEventListener ) {
    DOMContentLoaded = function() {
      document.removeEventListener( "DOMContentLoaded", DOMContentLoaded, false );
      ReadyObj.ready();
    };

  } else if ( document.attachEvent ) {
    DOMContentLoaded = function() {
      // Make sure body exists, at least, in case IE gets a little overzealous (ticket #5443).
      if ( document.readyState === "complete" ) {
        document.detachEvent( "onreadystatechange", DOMContentLoaded );
        ReadyObj.ready();
      }
    };
  }
  function ready( fn ) {
    // Attach the listeners
    ReadyObj.bindReady();

    var type = ReadyObj.type( fn );

    // Add the callback
    readyList.done( fn );//readyList is result of _Deferred()
  }
  return ready;
})();

function harlemShake()
{
  var MIN_HEIGHT = 30;
  var MIN_WIDTH = 30;
  var MAX_HEIGHT = 350;
  var MAX_WIDTH = 350;

  var CSS_BASE_CLASS = "mw-harlem_shake_me"
  var CSS_FIRST_CLASS = "im_first";
  var CSS_OTHER_CLASSES = ["im_drunk", "im_baked", "im_trippin", "im_blown"];

  var CSS_STROBE_CLASS = "mw-strobe_light";

  var PATH_TO_CSS = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css";
  var FILE_ADDED_CLASS = "mw_added_css"

  function addCSS() {
    var css = document.createElement("link");
    css.setAttribute("type", "text/css");
    css.setAttribute("rel", "stylesheet");
    css.setAttribute("href", PATH_TO_CSS);
    css.setAttribute("class", FILE_ADDED_CLASS);

    document.body.appendChild(css);
  }

  function removeAddedFiles() {
    var addedFiles = document.getElementsByClassName(FILE_ADDED_CLASS);
    for (var i=0; i<addedFiles.length; i++) {
      document.body.removeChild(addedFiles[i]);
    }
  }

  function flashScreen() {
    var flash = document.createElement("div");
    flash.setAttribute("class", CSS_STROBE_CLASS);
    document.body.appendChild(flash);

    setTimeout(function() {
      document.body.removeChild(flash);
    }, 100);
  }

  function size(node) {
    return {
      height: node.offsetHeight,
      width: node.offsetWidth
    }
  }

  function withinBounds(node) {
    var nodeFrame = size(node);
    return (nodeFrame.height > MIN_HEIGHT &&
        nodeFrame.height < MAX_HEIGHT &&
        nodeFrame.width > MIN_WIDTH &&
        nodeFrame.width < MAX_WIDTH);
  }

  function posY(elm) {
    var test = elm;
    var top = 0;
    while (!!test) {
      top += test.offsetTop;
      test = test.offsetParent;
    }
    return top;
  }

  function viewPortHeight() {
    var de = document.documentElement;
    if (!!window.innerWidth) {
      return window.innerHeight;
    } else if (de && !isNaN(de.clientHeight)) {
      return de.clientHeight;
    }
    return 0;
  }

  function scrollY() {
    if (window.pageYOffset) {
      return window.pageYOffset;
    }
    return Math.max(document.documentElement.scrollTop, document.body.scrollTop);
  }

  var vpH = viewPortHeight();
  var st = scrollY();
  function isVisible(node) {
    var y = posY(node);

    return (y >= st && y <= (vpH + st));
  }

  function playSong() {
    setTimeout(function() {
      shakeFirst(firstNode);
    }, 800);

    // setTimeout
    setTimeout(function() {
      stopShakeAll();
      flashScreen();
      for (var i=0; i<allShakeableNodes.length; i++) {
        shakeOther(allShakeableNodes[i]);
      }
    }, 16500);
  }

  function shakeFirst(node) {
    node.className += " "+CSS_BASE_CLASS+" "+CSS_FIRST_CLASS;
  }
  function shakeOther(node) {
    node.className += " "+CSS_BASE_CLASS+" "+CSS_OTHER_CLASSES[Math.floor(Math.random()*CSS_OTHER_CLASSES.length)];
  }

  function stopShakeAll() {
    var shakingNodes = document.getElementsByClassName(CSS_BASE_CLASS);
    var regex = new RegExp('\\b'+CSS_BASE_CLASS+'\\b');
    for (var i=0; i<shakingNodes.length; ) {
      shakingNodes[i].className =  shakingNodes[i].className.replace(regex, "");
    }
  }

  // get first item
  var allNodes = document.getElementsByTagName("*");
  var firstNode = null;
  for (var i=0; i<allNodes.length; i++) {
    var thisNode = allNodes[i];
    if (withinBounds(thisNode)) {
      if(isVisible(thisNode)) {
        firstNode = thisNode;
        break;
      }
    }
  }
  // insert CSS
  addCSS();

  // play song
  playSong();

  var allShakeableNodes = [];

  for (var i=0; i<allNodes.length; i++) {
    var thisNode = allNodes[i];
    if (withinBounds(thisNode)) {
      allShakeableNodes.push(thisNode);
    }
  }

}
